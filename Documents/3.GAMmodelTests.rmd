---
title: "GAM analysis of the weekly data"
author: "Willem Vervoort, Michaela Dolk & Floris van Ogtrop"
date: "`r Sys.Date()`"
output: 
    pdf_document:
      fig_width: 7
      fig_height: 6
      fig_caption: true
---
```{r setup, warning=F, message=F}
# root dir
knitr::opts_knit$set(root.dir = 
                       "C:/Users/rver4657/ownCloud/Virtual Experiments/VirtExp")
knitr::opts_chunk$set(echo = TRUE)
# LOAD REQUIRED PACKAGES # #####
library(pander)
library(tidyr)
library(xts)
library(zoo)
library(mgcv)
library(oz)
library(Kendall)
library(ggplot2)
library(doParallel)
library(foreach)

```

This rmarkdown document and the resulting pdf are stored on  [github](https://github.com/WillemVervoort/VirtExp). All directories (apart from the root working directory) refer to the directories in this repository

# Introduction
This document is related to the manuscript "Disentangling climate change trends in Australian streamflow" (vervoort et al.), submitted to Journal of Hydrology.  
This part of the series covers the analysis of the streamflow data using Generalised Additive models (GAM) testing for a trend in the data, or testing for a trend in the residuals. In particular, this extends the Mann Kendall analysis, as the Mann Kendall tau only indicates a strength, significance and direction of the trend, but does not quantify the magnitude of the trend.  
The different models are outlined in **Table 2** in the main manuscript. The methods describe in detail how the GAM are developed with reference to the underlying theory.  
This document follows **Table 2** in the series of models, so the headings (and model numbers) relate to this table.  

# The data  
Using the datasets that were developed earlier, we can load in the daily data for streamflow, rainfall and temperature.

```{r loadData}
load("data/DailyDataIncludingGridded.Rdata")
load("data/ClimCh_project_MD.Rdata")
# correct the column name of maxT in GridRainAllDataout
colnames(GridRainAllDataout)[5] <- "MaxT"
```

# The models (from Table 2 in the manuscript)
Table 2 in the manuscript (reproduced below) outlines the different models that were analysed using the statistical general additive models.
```{r Table2}
table2 <- read.csv("documents/Table2Models.csv")
pander(table2,caption = "Model structures used in the Generalised additive modelling analysis")
```

# Model 1 Only flow and trend
The first 2 models are actually not generalised additive mixed models (GAM) as the models only analyse a linear trend. To match the GAM analysis, we used generalised least squares (`gls()`) in R. This still allows correlated errors to be analysed

```{r model1, fig.cap="Residuals of linear mixed model analysis for trend in flow only"}
# run the gls model on flowtrend only
#for (i in seq_along(Stations[,1])) {
cl <- makeCluster(4) # create a cluster with 4 cores
registerDoParallel(cl) # register the cluster
# use a foreach loop to calibrate
Store2 <- foreach(i = 1:length(Stations[,1]),
                 .packages="mgcv") %dopar% {
# for (i in seq_along(Stations[,1])) {
#   i <- 1
  gamm.data <- subset(flow_rain_maxT_weekly,
                      flow_rain_maxT_weekly$Station == Stations[i,1])
  gamm.data$trend <- 1:nrow(gamm.data)
  gam_TrendOnly <- gls(log(Flow +1)~trend, correlation= corCAR1(),
       data=gamm.data)
  out <- list(model = gam_TrendOnly,
              results = data.frame(Station=Stations[i,1],
              t(summary(gam_TrendOnly)$tTable[2,c(1,4)]),
                   AIC=summary(gam_TrendOnly)$AIC))
  out
}
stopCluster(cl)

par(mfrow=c(5,3),mar=c(2,2,2,2))
for (i in seq_along(Stations[,1])) {
  res <- residuals(Store2[[i]]$model)  
  plot(res, main=Stations[i,1], cex.main=0.7,
       ylab="normalised residuals",xlab="")
  n <- length(res)
  abline(lsfit(1:n, res), col="red")
}

# store results
storedir <- "c:/users/rver4657/owncloud/virtual experiments"
save(Store2,file=paste(storedir,
                "projectdata/Store2_TrendOnlyAnalysis.RData",
                sep="/"))
output <- do.call(rbind, lapply(1:length(Store2), function(i) rbind(Store2[[i]][[2]])))
pander(output, caption="Mixed model results for analysis of trend in flow only")
rm(Store2)
```

# Model 2 trend in rain  
## Rainfall Station measured data  
Similar to the flow data, this analysis uses `gls()` to run the linear mixed model to test for a trend in the data and compare to the Mann-Kendall results

```{r model2a, fig.cap="Residuals of linear mixed model analysis for trend in station rainfall data"}
# create an empty list
# and an empty dataframe to store results
# run the gls model on flowtrend only
cl <- makeCluster(4) # create a cluster with 4 cores
registerDoParallel(cl) # register the cluster
# use a foreach loop to calibrate
Store_Rain <- foreach(i = 1:length(Stations[,1]),
                 .packages="mgcv") %dopar% {
  gamm.data <- subset(flow_rain_maxT_weekly,
                      flow_rain_maxT_weekly$Station == Stations[i,1])
  gamm.data$trend <- 1:nrow(gamm.data)
  gam_TrendR <- gls(log(Rain + 1)~trend, correlation= corCAR1(),
       data=na.omit(gamm.data))
  out <- list(model = gam_TrendR,
              results = data.frame(Station=Stations[i,1],
                     t(summary(gam_TrendR)$tTable[2,c(1,4)]),
                                   AIC=summary(gam_TrendR)$AIC))
  out
}
stopCluster(cl)


par(mfrow=c(5,3),mar=c(2,2,2,2))
for (i in seq_along(Stations[,1])) {
  res <- residuals(Store_Rain[[i]]$model)  
  plot(res, main=Stations[i,1], cex.main=0.5,
       ylab="normalised residuals",xlab="")
  n <- length(res)
  abline(lsfit(1:n, res), col="red")
}

# store results
save(Store_Rain,file=paste(storedir,
                  "projectdata/StoreRain_TrendAnalysis.RData",
                    sep="/"))
output <- do.call(rbind, lapply(1:length(Store_Rain), 
                     function(i) rbind(Store_Rain[[i]][[2]])))
pander(output, caption="Mixed model results for analysis of trend in Station Rainfall")
rm(Store_Rain)
```

## Rainfall gridded data analysis  
Repeat the rainfall analysis for the gridded data to compare station data to gridded data.  

```{r model2b, fig.cap="Residuals of linear mixed model analysis for trend in station rainfall data"}
# create an empty list
# and an empty dataframe to store results
# run the gls model on gridraintrend only
cl <- makeCluster(4) # create a cluster with 4 cores
registerDoParallel(cl) # register the cluster
# use a foreach loop to calibrate
Store_GridRain <- foreach(i = 1:length(Stations[,1]),
                 .packages="mgcv") %dopar% {
  gamm.data <- subset(weekGridRainAllDataout,
                      weekGridRainAllDataout$Station == Stations[i,1])
  gamm.data$trend <- 1:nrow(gamm.data)
  gam_TrendGridR <- gls(log(gridRain +1)~trend, correlation= corCAR1(),
       data=gamm.data)
  out <- list(model = gam_TrendGridR,
              results = data.frame(Station=Stations[i,1],
                         t(summary(gam_TrendGridR)$tTable[2,c(1,4)]),
                                   AIC=summary(gam_TrendGridR)$AIC))
  out
    }
stopCluster(cl)


par(mfrow=c(5,3),mar=c(2,2,2,2))
for (i in seq_along(Stations[,1])) {
  res <- residuals(Store_GridRain[[i]]$model)  
  plot(res, main=Stations[i,1], cex.main=0.5,
       ylab="normalised residuals",xlab="")
  n <- length(res)
  abline(lsfit(1:n, res), col="red")
}

# store results
save(Store_GridRain,
     file=paste(storedir,
                "projectdata/StoreGridRain_TrendAnalysis.RData",
                sep="/"))
output <- do.call(rbind, lapply(1:length(Store_GridRain), 
              function(i) rbind(Store_GridRain[[i]][[2]])))
pander(output, caption="Mixed model results for analysis of trend in Gridded Rainfall")
rm(Store_GridRain)
```

# Model 3 GAMM with rainfall  
This model analyses flow as a function of rainfall only. This is therefore an analysis of the rainfall runoff coefficient, taking into account a possible time trend in the data. If the trend in this analysis is significant, then this is a measure of how the rainfall runoff coefficient has changed over time.  
Again the analysis is run twice, once with station rainfall data (model 3a) and once with gridded rainfall data (model 3b).

## Station rainfall data  

```{r model3a, fig.cap="Residuals of GAMM analysis for trend in flow data taking into consideration station rainfall data"}
# Gamm model with flow and rain
cl <- makeCluster(4) # create a cluster with 4 cores
registerDoParallel(cl) # register the cluster
# use a foreach loop to calibrate
Store_FwR <- foreach(i = 1:length(Stations[,1]),
                 .packages="mgcv") %dopar% {
  gamm.data <- subset(flow_rain_maxT_weekly,
                      flow_rain_maxT_weekly$Station == Stations[i,1])
  gamm.data$trend <- 1:nrow(gamm.data)
  gam_TrendFlow_withR <- gamm(log(Flow +1)~s(Rain) + trend, 
                                  correlation= corCAR1(), data=gamm.data)
  out <- list(model = gam_TrendFlow_withR,
              results = data.frame(Station=Stations[i,1],
                            t(summary(gam_TrendFlow_withR$lme)$tTable[2,c(1,4)]),
                                   AIC=summary(gam_TrendFlow_withR$lme)$AIC))
  out
   }
stopCluster(cl)

par(mfrow=c(5,3), mar=c(2,2,2,2))
for (i in seq_along(Stations[,1])) {
  res <- residuals(Store_FwR[[i]]$model$lme)  
  plot(res, main=Stations[i,1], cex.main=0.5,
       ylab="normalised residuals",xlab="")
  n <- length(res)
  abline(lsfit(1:n, res), col="red")
}

# store results
save(Store_FwR,
     file=paste(storedir,
              "projectdata/StoreFwR_TrendAnalysis.RData",
              sep="/"))
output <- do.call(rbind, lapply(1:length(Store_FwR), 
                                function(i) rbind(Store_FwR[[i]][[2]])))
pander(output, caption="Mixed model results for analysis of trend in flow data taking into account Rainfall")
rm(Store_FwR)
```

## Gridded rainfall data  

```{r model3b, fig.cap="Residuals of GAMM analysis for trend in flow data taking into consideration gridded rainfall data"}
#gam model with flow and gridded rainfall
cl <- makeCluster(4) # create a cluster with 4 cores
registerDoParallel(cl) # register the cluster
# use a foreach loop to calibrate
Store_FwGR <- foreach(i = 1:length(Stations[,1]),
                 .packages="mgcv") %dopar% {
  gamm.data <- subset(weekGridRainAllDataout,
                      weekGridRainAllDataout$Station == Stations[i,1])
  gamm.data$trend <- 1:nrow(gamm.data)
  gam_TrendFlow_withGR <- gamm(log(Flow +1)~s(gridRain) + trend, 
                                  correlation= corCAR1(), data=gamm.data)
  out <- list(model = gam_TrendFlow_withGR,
              results = data.frame(Station=Stations[i,1],
                            t(summary(gam_TrendFlow_withGR$lme)$tTable[2,c(1,4)]),
                                   AIC=summary(gam_TrendFlow_withGR$lme)$AIC))
  out
   }
stopCluster(cl)

par(mfrow=c(5,3), mar=c(2,2,2,2))
for (i in seq_along(Stations[,1])) {
  res <- residuals(Store_FwGR[[i]]$model$lme)  
  plot(res, main=Stations[i,1], cex.main=0.5,
       ylab="normalised residuals",xlab="")
  n <- length(res)
  abline(lsfit(1:n, res), col="red")
}

# store results
save(Store_FwGR,
     file=paste(storedir,
                "projectdata/StoreFwGR_TrendAnalysis.RData",
                sep = "/"))
output <- do.call(rbind, lapply(1:length(Store_FwGR), 
                                function(i) rbind(Store_FwGR[[i]][[2]])))
pander(output, caption="Mixed model results for analysis of trend in flow data taking into account Gridded Rainfall")
rm(Store_FwGR)
```

# Model 4. GAMM with rain & s(rain,MaxT) and trend
This model analyses flow as a function of rainfall and the interaction between rainfall and maximum temperature, which is conceptualised as the actual evapotranspiration. This is therefore an analysis of the rainfall runoff coefficient, taking into account the changes in evapotranspiration and a possible time trend in the data. If the trend in this analysis is significant, then this is a measure of how the rainfall runoff coefficient has changed over time.  
Again the analysis is run twice, once with station rainfall data (model 3a) and once with gridded rainfall data (model 3b).

## Station rainfall data  

```{r model4a, fig.cap="Residuals of GAMM analysis for trend in flow data removing station rainfall and evapotranspiration effects"}
# run the gamm model on rain, maxT and flow
cl <- makeCluster(4) # create a cluster with 4 cores
registerDoParallel(cl) # register the cluster
# use a foreach loop to calibrate
Store_FwRE <- foreach(i = 1:length(Stations[,1]),
                 .packages="mgcv") %dopar% {
  gamm.data <- subset(flow_rain_maxT_weekly,
                      flow_rain_maxT_weekly$Station == Stations[i,1])
  gamm.data$trend <- 1:nrow(gamm.data)
  gam_TrendFlow_withRandE <- gamm(log(Flow +1)~s(Rain) + s(Rain, MaxT) + 
                                       trend, correlation= corCAR1(),
                                       data=gamm.data, control=list(niterEM=0))
  out <- list(model = gam_TrendFlow_withRandE,
        results = data.frame(Station=Stations[i,1],
                      t(summary(gam_TrendFlow_withRandE$lme)$tTable[2,c(1,4)]),
                            AIC=summary(gam_TrendFlow_withRandE$lme)$AIC))
  out
 }
stopCluster(cl)

par(mfrow=c(5,3), mar=c(2,2,2,2))
for (i in seq_along(Stations[,1])) {
  res <- residuals(Store_FwRE[[i]]$model$lme)  
  plot(res, main=Stations[i,1], cex.main=0.5,
       ylab="normalised residuals",xlab="")
  n <- length(res)
  abline(lsfit(1:n, res), col="red")
}

# store results
save(Store_FwRE,
     file=paste(storedir,
                "projectdata/StoreFwRE_TrendAnalysis.RData",
                sep = "/"))
output <- do.call(rbind, lapply(1:length(Store_FwRE), 
                                function(i) rbind(Store_FwRE[[i]][[2]])))
pander(output, caption="Mixed model results for the analysis of trend in flow data taking into account Rainfall and Evapotranspiratiion")
rm(Store_FwRE)
```

## Gridded rainfall data  

```{r model4b, fig.cap="Residuals of GAMM analysis for trend in flow data removing gridded rainfall and evapotranspiration effects"}
# run the gamm model on gridded rain, maxT and flow
cl <- makeCluster(4) # create a cluster with 4 cores
registerDoParallel(cl) # register the cluster
# use a foreach loop to calibrate
Store_FwGRE <- foreach(i = 1:length(Stations[,1]),
                 .packages="mgcv") %dopar% {
  gamm.data <- subset(weekGridRainAllDataout,
                      weekGridRainAllDataout$Station == Stations[i,1])
  gamm.data$trend <- 1:nrow(gamm.data)
  gam_TrendFlow_withGRE <- gamm(log(Flow +1)~s(gridRain) + s(gridRain,MaxT) +
                                       trend, correlation= corCAR1(),
                                     data=gamm.data, control=list(niterEM=5))
  out <- list(model = gam_TrendFlow_withGRE,
        results = data.frame(Station=Stations[i,1],
                      t(summary(gam_TrendFlow_withGRE$lme)$tTable[2,c(1,4)]),
                            AIC=summary(gam_TrendFlow_withGRE$lme)$AIC))
  out
}
stopCluster(cl)

par(mfrow=c(5,3),mar=c(2,2,2,2))
for (i in seq_along(Stations[,1])) {
  res <- residuals(Store_FwGRE[[i]]$model$lme)  
  plot(res, main=Stations[i,1], cex.main=0.5,
       ylab="normalised residuals",xlab="")
  n <- length(res)
  abline(lsfit(1:n, res), col="red")
}

# store results
save(Store_FwGRE,
     file=paste(storedir,
                "projectdata/StoreFwGRE_TrendAnalysis.RData",
                sep="/"))
output <- do.call(rbind, lapply(1:length(Store_FwGRE), 
                                function(i) rbind(Store_FwGRE[[i]][[2]])))
pander(output, caption="Mixed model results for analysis of trend in flow data taking into account Gridded Rainfall and Evapotranspiration")
rm(Store_FwGRE)
```


# Model 5, same as model 4, but no trend and Mann Kendall on the residuals
This last model is to check the trend with GAMM analysis with the analysis using Mann-Kendall. So rather than incorporating a trend in the model, we analyse the residuals using Mann-Kendall for a trend. In this case we drop the plotting of the residuals.

## Station rainfall data  

```{r model5a}
# run the gamm model on rain, maxT and flow
cl <- makeCluster(4) # create a cluster with 4 cores
registerDoParallel(cl) # register the cluster
# use a foreach loop to calibrate
Store_FwRE2 <- foreach(i = 1:length(Stations[,1]),
                 .packages="mgcv") %dopar% {
  gamm.data <- subset(flow_rain_maxT_weekly,
                      flow_rain_maxT_weekly$Station == Stations[i,1])
  gam_Flow_withRandE <- gamm(log(Flow +1)~s(Rain) + s(Rain, MaxT) , 
                                  correlation= corCAR1(), data=gamm.data,
                                  control=list(niterEM=5))
  out <- list(model = gam_Flow_withRandE,
        results = data.frame(Station=Stations[i,1],
                            AIC=summary(gam_Flow_withRandE$lme)$AIC))
  out
}

stopCluster(cl)

# store results
save(Store_FwRE2,
     file=paste(storedir,
                "projectdata/StoreFwRE_Analysis.RData",
                sep="/"))
output <- do.call(rbind, lapply(1:length(Store_FwRE2), 
                                function(i) rbind(Store_FwRE2[[i]][[2]])))
pander(output, caption="Mixed model results for the analysis of flow data taking into account Rainfall and Evapotranspiration")
```

Now do the Mann-Kendall analysis on the residuals
```{r model5aMK, fig.cap="Mann Kendall analysis of the residuals of the streamflow after GAM model with rainfall and a Evapotranspiration"}
# do mann kendall on the residuals
resid_list <- vector("list", length=length(Stations[,1]))
for (i in seq_along(Stations[,1])) {
  resid_list[[i]] <- zoo(residuals(Store_FwRE2[[i]]$model$lme,
                 type="normalized"),
                 order.by=as.Date(na.omit(subset(flow_rain_maxT_weekly,                                                   Station==Stations[i,1]))$Date))
}
resid_df <- do.call(merge.zoo,resid_list)
names(resid_df) <- Stations[,1]
# Bootstrap
set.seed(10)
# now run a loop over the number of years (create 41 different sets)
# do Mann Kendall test on each resonstituted series
# ---------------------------
#  -------------------------
resid_temp <- as.data.frame(resid_df)
resid_temp$years <- format(time(resid_df),"%Y")
split_resid <- split(resid_temp[,1:13],resid_temp$years)


cl <- makeCluster(4) # create a cluster with 4 cores
registerDoParallel(cl) # register the cluster
# use a foreach loop to calibrate
MK_list <- foreach(i = 1:500,
                 .packages=c("Kendall", "xts")) %dopar% {
  # reorganise the list elements
  series <- sample(1:nyears(resid_df),nyears(resid_df))
  for (j in 1:length(series)) {
    if (j==1) { 
      new_df <- as.data.frame(split_resid[[series[j]]])
    } else {
      new_df <- rbind(new_df,as.data.frame(split_resid[[series[j]]]))
    }
  }
  # run mann kendall on the columns and store the results
  mk_r <- apply(new_df,2,MannKendall)
  
  out <- do.call(cbind,mk_r)
  out
 }
stopCluster(cl)


MK_df <- do.call(rbind,MK_list)

pvalues <- subset(MK_df, rownames(MK_df)=="sl")
tau <- subset(MK_df, rownames(MK_df)=="tau")

sig_set <- list()

for (i in 1:ncol(pvalues)) {
  set <- data.frame(pvalue=as.numeric(pvalues[,i]),
                    tau=as.numeric(tau[,i]),catch=rep(colnames(MK_df)[i],nrow(tau)))
  sig_set[[i]] <- set[set$pvalue < 0.5,]
}

sig_set_a <- do.call(rbind,sig_set)
sig_set_a$type <- rep("bootstrap",nrow(sig_set_a))


MK_resid <- do.call(rbind,lapply(resid_list,MannKendall))


real_df <- data.frame(pvalue = as.numeric(MK_resid[,2]), 
                      tau = as.numeric(MK_resid[,1]),
                      catch=Stations[,1],
                      type=rep("real",nrow(MK_resid)))
# A histogram of taus

hp <- ggplot(sig_set_a, aes(x=tau)) + geom_histogram(binwidth=0.03,colour="white")
# Histogram of significant tau's, divided by catch
# With panels that have the same scaling, but different range 
# (and therefore different physical sizes)
hp <- hp + facet_wrap(~ catch,ncol=5)
# add a red point for the real slope from the data
p_value <- ifelse(real_df$pvalue<0.05,"< 0.05",">= 0.05")
hp <- hp + geom_point(data=real_df,aes(x=tau, y=0,colour=p_value),
                shape=16,size=5) + 
  facet_wrap(~ catch,ncol=5)+ ggtitle("Residuals Streamflow after GAM") #+
hp <- hp + scale_colour_grey(start = 0, end = 0.6)
print(hp)
save(hp, file="../Figure8ResidGAM_MDPaper.Rdata")

# # production quality tiff, this is Figure 8 in the manuscript
tiff("../manuscript/Figure8_ResidGAM_MDPaper.tif",res=600,compression="lzw",
     width=10*480,height=10*480)
print(hp)
dev.off()

pander(real_df, caption="Mann Kendall results for the GAMM residuals, ref Figure 8")
rm(Store_FwRE2)
```

## Gridded rainfall data   
Do the same for the gridded rainfall data  
```{r model5b, fig.cap="Residuals of GAMM analysis of flow data removing gridded rainfall and evapotranspiration effects"}
# run the gamm model on rain, maxT and flow
cl <- makeCluster(4) # create a cluster with 4 cores
registerDoParallel(cl) # register the cluster
# use a foreach loop to calibrate
Store_FwGRE2 <- foreach(i = 1:length(Stations[,1]),
                 .packages="mgcv") %dopar% {  
  gamm.data <- subset(weekGridRainAllDataout,
                      weekGridRainAllDataout$Station == Stations[i,1])
  gam_Flow_withGRE <- gamm(log(Flow +1)~s(gridRain) + s(gridRain,MaxT),
                                     correlation= corCAR1(), data=gamm.data,
                                     control=list(niterEM=5))
  out <- list(model = gam_Flow_withGRE,
        results = data.frame(Station=Stations[i,1],
                            AIC=summary(gam_Flow_withGRE$lme)$AIC))
  out
}

stopCluster(cl)

# store results
save(Store_FwGRE2,
     file=paste(storedir,
                "projectdata/StoreFwGRE2_TrendAnalysis.RData",
                sep="/"))
output <- do.call(rbind, lapply(1:length(Store_FwGRE2), 
                                function(i) rbind(Store_FwGRE2[[i]][[2]])))
pander(output, caption="Mixed model results for analysis of trend in flow data taking into account Gridded Rainfall and Evapotranspiration")

```

Now do the Mann-Kendall analysis on the residuals
```{r model5bMK, fig.cap="Mann Kendall analysis of the residuals of the streamflow after GAM model with gridded rainfall and a Evapotranspiration"}
# do mann kendall on the residuals
resid_list <- vector("list", length=length(Stations[,1]))
for (i in seq_along(Stations[,1])) {
  resid_list[[i]] <- zoo(residuals(Store_FwGRE2[[i]]$model$lme,
                 type="normalized"),
                 order.by=as.Date(na.omit(subset(flow_rain_maxT_weekly,                                                   Station==Stations[i,1]))$Date))
}
resid_df <- do.call(merge.zoo,resid_list)
names(resid_df) <- Stations[,1]
# Bootstrap
# now run a loop over the number of years (create 41 different sets)
# do Mann Kendall test on each resonstituted series
# ---------------------------
#  -------------------------
resid_temp <- as.data.frame(resid_df)
resid_temp$years <- format(time(resid_df),"%Y")
split_resid <- split(resid_temp[,1:13],resid_temp$years)


cl <- makeCluster(4) # create a cluster with 4 cores
registerDoParallel(cl) # register the cluster
# use a foreach loop to calibrate
MK_list <- foreach(i = 1:500,
                 .packages=c("Kendall","xts")) %dopar% {
  # reorganise the list elements
  series <- sample(1:nyears(resid_df),nyears(resid_df))
  for (j in 1:length(series)) {
    if (j==1) { 
      new_df <- as.data.frame(split_resid[[series[j]]])
    } else {
      new_df <- rbind(new_df,as.data.frame(split_resid[[series[j]]]))
    }
  }
  # run mann kendall on the columns and store the results
  mk_r <- apply(new_df,2,MannKendall)
  
  out <- do.call(cbind,mk_r)
  out
 }
stopCluster(cl)

MK_df <- do.call(rbind,MK_list)

pvalues <- subset(MK_df, rownames(MK_df)=="sl")
tau <- subset(MK_df, rownames(MK_df)=="tau")

sig_set <- list()

for (i in 1:ncol(pvalues)) {
  set <- data.frame(pvalue=as.numeric(pvalues[,i]),
                    tau=as.numeric(tau[,i]),catch=rep(colnames(MK_df)[i],nrow(tau)))
  sig_set[[i]] <- set[set$pvalue < 0.5,]
}

sig_set_a <- do.call(rbind,sig_set)
sig_set_a$type <- rep("bootstrap",nrow(sig_set_a))


MK_resid <- do.call(rbind,lapply(resid_list,MannKendall))


real_df <- data.frame(pvalue = as.numeric(MK_resid[,2]), 
                      tau = as.numeric(MK_resid[,1]),
                      catch=Stations[,1],
                      type=rep("real",nrow(MK_resid)))
# A histogram of taus

hp <- ggplot(sig_set_a, aes(x=tau)) + geom_histogram(binwidth=0.03,colour="white")
# Histogram of significant tau's, divided by catch
# With panels that have the same scaling, but different range 
# (and therefore different physical sizes)
hp <- hp + facet_wrap(~ catch,ncol=5)
# add a red point for the real slope from the data
p_value <- ifelse(real_df$pvalue<0.05,"< 0.05",">= 0.05")
hp <- hp + geom_point(data=real_df,aes(x=tau, y=0,colour=p_value),
                shape=16,size=5) + 
  facet_wrap(~ catch,ncol=5)+ ggtitle("Residuals Streamflow after GAM") #+
hp <- hp + scale_colour_grey(start = 0, end = 0.6)
print(hp)


pander(real_df, caption="Mann Kendall results for the GAMM residuals with gridded rainfall")
rm(Store_FwGRE2)
```
